name: CI & Deploy (develop)

on:
  # PR 생성/업데이트 시 CI만 실행
  #pull_request:
  #  branches: [ develop ]

  # develop 브랜치에 merge(push) 시 CI와 배포
  push:
    branches: [ deploy ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build

      # JAR 이름 고정
      - name: Prepare JAR
        run: |
          JAR=$(ls build/libs/*.jar | head -n 1)
          cp "$JAR" app.jar

      # 기존 디렉토리/파일 전부 제거
      - name: Remove old app on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            mkdir -p /home/ubuntu/app
            rm -rf /home/ubuntu/app/app.jar

      # 디렉토리로 풀리는 걸 감안해서 전송
      - name: Copy JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: app.jar
          target: /home/ubuntu/app

      # 실제 파일을 원하는 위치로 정리
      - name: Normalize JAR on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/app
            if [ -d app.jar ]; then
              mv app.jar/app.jar ./app.jar
              rm -rf app.jar
            fi

      # 실행
      - name: Run application on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            cd /home/ubuntu/app
            pkill -f app.jar || true

            setsid nohup java -jar app.jar > app.log 2>&1 </dev/null &

            sleep 2
            pgrep -fl app.jar || true
            exit 0

#  ci:
#    name: CI (Build & Test)
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Checkout source
#        uses: actions/checkout@v4
#
#      - name: Set up JDK 21
#        uses: actions/setup-java@v4
#        with:
#          java-version: '21'
#          distribution: 'temurin'
#
#      - name: Grant execute permission for gradlew
#        run: chmod +x gradlew
#
#      - name: Build with Gradle
#        run: ./gradlew clean build
#
#  deploy:
#    name: Deploy to EC2
#    runs-on: ubuntu-latest
#
#    # develop 브랜치에 push 되었을 때만 실행
#    if: github.event_name == 'push'
#    needs: ci
#
#    steps:
#      - name: Checkout source
#        uses: actions/checkout@v4
#
#      - name: Set up JDK 21
#        uses: actions/setup-java@v4
#        with:
#          java-version: '21'
#          distribution: 'temurin'
#
#      - name: Grant execute permission for gradlew
#        run: chmod +x gradlew
#
#      - name: Build with Gradle
#        run: ./gradlew clean build
#
#      - name: Copy JAR to EC2
#        uses: appleboy/scp-action@v0.1.7
#        with:
#          host: ${{ secrets.EC2_HOST }}
#          username: ubuntu
#          key: ${{ secrets.EC2_SSH_KEY }}
#          source: build/libs/*.jar
#          target: /home/ubuntu/app
#
#      - name: Run application on EC2
#        uses: appleboy/ssh-action@v1.0.3
#        with:
#          host: ${{ secrets.EC2_HOST }}
#          username: ubuntu
#          key: ${{ secrets.EC2_SSH_KEY }}
#          script: |
#            mkdir -p /home/ubuntu/app
#            cd /home/ubuntu/app
#
#            # 기존 실행 파일 종료
#            pgrep -f '.jar' && pkill -f '.jar' || true
#
#            # 최신 JAR 실행
#            nohup java -jar *.jar > app.log 2>&1 &
